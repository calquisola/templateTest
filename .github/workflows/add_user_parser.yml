name: Process order
on:
  issues:
    types: [opened]

concurrency: 'main'
jobs:
  place_order:
    if: contains(github.event.issue.labels.*.name, 'onboarding')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-node@v2
        with:
          node-version: '16'
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: |
          echo "$GITHUB_CONTEXT"

      - uses: stefanbuck/github-issue-parser@ef76e9c47f5e2fd68ae29860970ecb40c687752f
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/add_dev_user.yml
      - name: Get email
        run: | 
            echo '${{ steps.issue-parser.outputs.jsonString }}' > user.json
            cat user.json
      - name: Format Json for aws cli
        run: |
          mkdir pst_amt_dynamodb
          python scripts/format_request.py user.json users pst_amt_dynamodb
      - name:  Add/Remove DynamoDB Items
        run: |
          aws dynamodb batch-write-item --request-items file://pst_amt_dynamodb/add_user.json
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: 'us-east-1'    
      - name: Close Issue
        uses: peter-evans/close-issue@a2a8c6a06a43191c71ebc39eec8ead0170ffadf4
        with:
          comment: |
            Hi! You have been added.
           
      